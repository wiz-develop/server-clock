!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WizDevelopServerClock={})}(this,(function(e){"use strict";function t(e,t,r,o){return new(r||(r=Promise))((function(s,i){function n(e){try{a(o.next(e))}catch(e){i(e)}}function l(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,l)}a((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const r=(e,r=3e3,o)=>t(void 0,void 0,void 0,(function*(){if("undefined"!=typeof navigator&&!navigator.onLine&&o)return o;return((e,t)=>{if(0===e.length)return{status:"client_only",offset:0};const{maxLb:r,minUb:o}=e.reduce(((e,t)=>({maxLb:Math.max(e.maxLb,t.lb),minUb:Math.min(e.minUb,t.ub)})),{maxLb:-1/0,minUb:1/0}),s=-(r+o)/2;return e.length>=t.length&&r<o&&o-r<500?{status:"accurate",offset:s}:{status:"server_only",offset:s}})((yield Promise.allSettled(e.map((e=>t(void 0,void 0,void 0,(function*(){const o=Date.now(),s=yield((e,r=3e3)=>t(void 0,void 0,void 0,(function*(){return Promise.race([fetch(`${e}`,{method:"GET"}),new Promise(((e,t)=>{setTimeout((()=>t(new Error("❌ fetch timeout"))),r)}))])})))(e,r).catch((t=>{throw console.error(`[ServerClock] ❌ Failed to fetch data from '${e}': ${t}`),t})),i=Date.now(),n=yield s.json();if("object"!=typeof(l=n)||null===l||!("requestReceivedAt"in l)||!("responseSentAt"in l)||null==l.requestReceivedAt||null==l.responseSentAt||"number"!=typeof l.requestReceivedAt||"number"!=typeof l.responseSentAt)throw console.error(`[ServerClock] ❌ Invalid server response from '${e}'`),new Error(`Invalid server response from '${e}'`);var l;return((e,t,r)=>{const o=r.requestReceivedAt,s=r.responseSentAt;return Object.assign(Object.assign({},r),{it:e,rt:t,rtt:t-e,diff:(o-e-(t-s))/2,lb:e-16-o,ub:t+16-s})})(o,i,n)})))))).filter((e=>"fulfilled"===e.status)).map((e=>e.value)),e)})),o=e=>`${e.getUTCFullYear()}/${(e.getUTCMonth()+1).toString().padStart(2,"0")}/${e.getUTCDate().toString().padStart(2,"0")} ${e.getUTCHours().toString().padStart(2,"0")}:${e.getUTCMinutes().toString().padStart(2,"0")}:${e.getUTCSeconds().toString().padStart(2,"0")}.${e.getUTCMilliseconds().toString().padStart(3,"0")}`;class s{constructor(e){var t,r,o,s;this.result={status:"pending",offset:0},this.clockloopTimer=null,this.fetchloopTimer=null,this.tickHandlers=new Set,this.serverUrls=e.serverUrls,this.fetchInterval=null!==(t=e.fetchInterval)&&void 0!==t?t:18e4,this.clockInterval=null!==(r=e.clockInterval)&&void 0!==r?r:10,this.fetchTimeout=null!==(o=e.fetchTimeout)&&void 0!==o?o:3e3,this.fallbackToLocal=null===(s=e.fallbackToLocal)||void 0===s||s}getClock(){const e=new Date,t=6e4*e.getTimezoneOffset(),r=e.getTime()+this.result.offset+this.clockInterval/2,s={status:this.result.status,offset:Math.round(this.result.offset/1e3*10)/10,LOCAL:new Date(e.getTime()-t),JST:new Date(r+324e5),UTC:new Date(r),LOC:new Date(r-t)};return Object.assign(Object.assign({},s),{LOCAL_STR:o(s.LOCAL),JST_STR:o(s.JST),UTC_STR:o(s.UTC),LOC_STR:o(s.LOC)})}onTick(e){return this.tickHandlers.add(e),()=>{this.tickHandlers.delete(e)}}start(){return t(this,void 0,void 0,(function*(){this.stop();try{this.result=yield r(this.serverUrls,this.fetchTimeout,this.fallbackToLocal?void 0:this.result)}catch(e){if(console.error("[ServerClock] Failed to initialize time offset:",e),!this.fallbackToLocal)throw e}this.fetchloopTimer=setInterval((()=>t(this,void 0,void 0,(function*(){try{this.result=yield r(this.serverUrls,this.fetchTimeout,this.result)}catch(e){console.error("[ServerClock] Failed to update time offset:",e)}}))),this.fetchInterval),this.clockloopTimer=setInterval((()=>{const e=this.getClock();this.tickHandlers.forEach((t=>{try{t(e)}catch(e){console.error("[ServerClock] Error in tick handler:",e)}}))}),this.clockInterval)}))}stop(){this.clockloopTimer&&(clearInterval(this.clockloopTimer),this.clockloopTimer=null),this.fetchloopTimer&&(clearInterval(this.fetchloopTimer),this.fetchloopTimer=null)}getTimeOffset(){return this.result.offset}getStatus(){return this.result.status}}class i{constructor(e,t="./worker.js"){this.worker=null,this.tickHandlers=new Set,this.handleWorkerMessage=e=>{this.tickHandlers.forEach((t=>{try{t(e.data)}catch(e){console.error("[ServerClock] Error in tick handler:",e)}}))},this.handleWorkerError=e=>{console.error("[ServerClock] Worker error:",e)},this.options=e,this.workerUrl=t}onTick(e){return this.tickHandlers.add(e),()=>{this.tickHandlers.delete(e)}}start(){this.worker&&this.stop();try{this.worker=new Worker(this.workerUrl),this.worker.addEventListener("message",this.handleWorkerMessage),this.worker.addEventListener("error",this.handleWorkerError),this.worker.postMessage({type:"start",serverList:this.options.serverUrls,fetchInterval:this.options.fetchInterval})}catch(e){throw console.error("[ServerClock] Failed to start worker:",e),e}}stop(){this.worker&&(this.worker.postMessage({type:"stop"}),this.worker.removeEventListener("message",this.handleWorkerMessage),this.worker.removeEventListener("error",this.handleWorkerError),this.worker.terminate(),this.worker=null)}static isWorkerAvailable(){return"undefined"!=typeof Worker}}class n{constructor(e,t=!1,r="./worker.js"){var o,n,l,a;this.lastTickData=null,this.tickHandlers=new Set,this.handleTick=e=>{this.lastTickData=e,this.tickHandlers.forEach((t=>{try{t(e)}catch(e){console.error("[ServerClock] Error in tick handler:",e)}}))},this.options=Object.assign(Object.assign({},e),{fetchInterval:null!==(o=e.fetchInterval)&&void 0!==o?o:18e4,clockInterval:null!==(n=e.clockInterval)&&void 0!==n?n:10,fetchTimeout:null!==(l=e.fetchTimeout)&&void 0!==l?l:3e3,fallbackToLocal:null===(a=e.fallbackToLocal)||void 0===a||a}),this.useWorker=!t&&i.isWorkerAvailable(),this.useWorker?this.implementation=new i(this.options,r):this.implementation=new s(this.options),this.implementation.onTick(this.handleTick)}onTick(e){if(this.tickHandlers.add(e),this.lastTickData)try{e(this.lastTickData)}catch(e){console.error("[ServerClock] Error in tick handler:",e)}return()=>{this.tickHandlers.delete(e)}}start(){return t(this,void 0,void 0,(function*(){this.useWorker?this.implementation.start():yield this.implementation.start()}))}stop(){this.implementation.stop()}isUsingWorker(){return this.useWorker}}e.ServerClock=n,e.default=n,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=bundle.min.js.map
